<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XtreamJson Stream Player</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/htmx.org@1.9.10"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.7/dist/hls.min.js"></script>
    <style>
        body { background: #181818; color: #fff; }
        .stream-container { max-width: 900px; margin: 40px auto; background: #222; border-radius: 10px; box-shadow: 0 2px 16px #0006; padding: 2rem; }
        video { width: 100%; height: auto; border-radius: 8px; background: #000; }
    </style>
</head>
<body>
    <div class="stream-container">
        <h2 class="mb-4">Streaming Player</h2>
        <div id="streamUrlDisplay" class="mb-2 text-info small"></div>
        <video id="player" controls autoplay preload="auto"></video>
        <div id="videoError" class="alert alert-danger mt-3 d-none"></div>
        <div id="vlcButtonContainer" class="mt-2"></div>
        <div id="vlcHelpText" class="text-secondary small mt-1"></div>
        <div class="mt-3">
            <a href="/" class="btn btn-secondary">Back to Home</a>
        </div>
    </div>
    <script>
        // Prefer server-injected url, fallback to query param
        let injectedUrl = null;
        try {
            injectedUrl = "[[${url}]]";
        } catch (e) { injectedUrl = null; }
        function getQueryParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }
        let streamUrl = injectedUrl && injectedUrl !== 'null' && injectedUrl !== '' ? injectedUrl : getQueryParam('url');
        const errorDiv = document.getElementById('videoError');
        const player = document.getElementById('player');
        const urlDisplay = document.getElementById('streamUrlDisplay');
        if (streamUrl) {
            urlDisplay.textContent = 'Stream URL: ' + streamUrl;
            const ext = streamUrl.split('.').pop().toLowerCase();
            if (ext === 'mkv' || ext === 'hevc' || streamUrl.includes('hevc') || streamUrl.includes('265')) {
                errorDiv.textContent = 'MKV, HEVC, and most 4K files are not supported in browsers. Please use MP4 (H.264/AAC) or HLS (.m3u8) for playback.';
                errorDiv.classList.remove('d-none');
                player.style.display = 'none';
                showVlcButton(streamUrl);
            } else if (ext === 'm3u8') {
                if (Hls.isSupported()) {
                    const hls = new Hls();
                    hls.loadSource(streamUrl);
                    hls.attachMedia(player);
                    hls.on(Hls.Events.ERROR, function(event, data) {
                        errorDiv.textContent = 'This video could not be played. The format or codec may not be supported by your browser.';
                        errorDiv.classList.remove('d-none');
                    });
                } else if (player.canPlayType('application/vnd.apple.mpegurl')) {
                    player.src = streamUrl;
                } else {
                    errorDiv.textContent = 'Your browser does not support this video format. Please use a modern browser or try a different file.';
                    errorDiv.classList.remove('d-none');
                    player.style.display = 'none';
                    showVlcButton(streamUrl);
                }
            } else if (ext === 'ts') {
                // Use backend transcoder for .ts files
                const transcodeUrl = '/transcode?url=' + encodeURIComponent(streamUrl);
                player.src = transcodeUrl;
                player.type = 'video/mp4';
                player.load();
                player.play();
                player.onerror = function() {
                    errorDiv.textContent = 'This .ts stream could not be transcoded or played. Please use VLC or check the stream source.';
                    errorDiv.classList.remove('d-none');
                    player.style.display = 'none';
                    showVlcButton(streamUrl);
                };
            } else {
                let mime = 'video/mp4';
                if (ext === 'webm') mime = 'video/webm';
                player.src = streamUrl;
                player.type = mime;
                player.load();
                player.play();
            }
        } else {
            urlDisplay.textContent = '';
            document.querySelector('.stream-container').innerHTML += '<div class="alert alert-danger">No stream URL provided. Please check the link or try again.</div>';
        }
        function showVlcButton(url) {
            const vlcContainer = document.getElementById('vlcButtonContainer');
            vlcContainer.innerHTML = '';
            // Button to copy URL to clipboard
            const copyBtn = document.createElement('button');
            copyBtn.className = 'btn btn-success me-2';
            copyBtn.textContent = 'Copy URL for VLC';
            copyBtn.onclick = function() {
                navigator.clipboard.writeText(url).then(function() {
                    copyBtn.textContent = 'Copied! Paste in VLC → Media → Open Network Stream';
                    setTimeout(() => { copyBtn.textContent = 'Copy URL for VLC'; }, 3000);
                });
            };
            vlcContainer.appendChild(copyBtn);
            // .m3u download
            const m3uContent = `#EXTM3U\n${url}\n`;
            const m3uBlob = new Blob([m3uContent], { type: 'audio/x-mpegurl' });
            const m3uUrl = URL.createObjectURL(m3uBlob);
            const m3uLink = document.createElement('a');
            m3uLink.href = m3uUrl;
            m3uLink.download = 'stream.m3u';
            m3uLink.className = 'btn btn-primary';
            m3uLink.textContent = 'Download .m3u for VLC';
            vlcContainer.appendChild(m3uLink);
            // Help text
            document.getElementById('vlcHelpText').innerHTML =
                'If the video does not play in your browser, copy the URL and paste it in VLC: <b>Media → Open Network Stream</b>.' +
                '<br>Or download the .m3u file and open it with VLC.';
        }
        player.addEventListener('error', function() {
            let message = 'This video could not be played. Most browsers only support MP4 (H.264/AAC).';
            errorDiv.textContent = message;
            errorDiv.classList.remove('d-none');
            showVlcButton(streamUrl);
        });
    </script>
</body>
</html>