<div th:fragment="epg-fragment">
  <div class="epg-header mb-3">
    <ul class="nav nav-tabs" id="epgCategoryTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button
          class="nav-link active"
          id="all-tab"
          data-bs-toggle="tab"
          type="button"
          onclick="filterCategory('all')"
        >
          All
        </button>
      </li>
      <th:block th:each="cat : ${categories}">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            th:id="'cat-' + ${cat.categoryId}"
            data-bs-toggle="tab"
            type="button"
            th:text="${cat.categoryName}"
            th:attr="onclick='filterCategory(\'' + ${cat.categoryId} + '\')'"
          ></button>
        </li>
      </th:block>
    </ul>
  </div>
  <div class="epg-container">
    <!-- Left Column: Channels -->
    <div class="channel-column">
      <div class="channel-row" style="height: 40px; background-color: #333">
        <!-- Empty corner -->
      </div>
      <div
        th:each="channel : ${channels}"
        class="channel-row"
        th:data-category-id="${channel.categoryId}"
      >
        <img
          th:if="${channel.icon != null}"
          th:src="@{/proxy/image(url=${channel.icon.src})}"
          style="width: 30px; height: 30px; margin-right: 10px"
        />
        <span th:text="${channel.displayName}">Channel Name</span>
      </div>
    </div>

    <!-- Right Column: Timeline & Programs -->
    <div class="timeline-area">
      <!-- Current Time Indicator -->
      <div
        class="current-time-indicator"
        th:style="'left: ' + ${nowOffset} + 'px;'"
      ></div>

      <!-- Timeline Header -->
      <div class="timeline-header">
        <div
          th:each="slot : ${timelineSlots}"
          th:text="${slot}"
          style="
            width: 120px;
            flex-shrink: 0;
            padding-left: 5px;
            border-right: 1px solid #444;
          "
        ></div>
      </div>

      <!-- Program Rows -->
      <div
        th:each="channel : ${channels}"
        class="program-row"
        th:data-category-id="${channel.categoryId}"
      >
        <th:block th:if="${programmesByChannel.containsKey(channel.id)}">
          <a
            th:each="prog : ${programmesByChannel.get(channel.id)}"
            th:href="${prog.streamUrl != null} ? @{/stream.html(url=${prog.streamUrl},title=${prog.title})} : '#'"
            class="program-item"
            th:text="${prog.title}"
            th:title="${prog.title + ' - ' + prog.desc}"
            th:style="${prog.style} + ' display: block; text-decoration: none; color: inherit;'"
          >
          </a>
        </th:block>
        <div
          th:unless="${programmesByChannel.containsKey(channel.id)}"
          style="padding: 10px"
        >
          <a
            th:if="${channel.streamUrl != null}"
            th:href="@{/stream.html(url=${channel.streamUrl},title=${channel.displayName})}"
            style="color: #bbb; text-decoration: underline; cursor: pointer"
            title="Click to play channel"
          >
            No Data
          </a>
          <span th:if="${channel.streamUrl == null}">No Data</span>
        </div>
      </div>
    </div>
  </div>

  <style>
    #epgCategoryTabs {
      flex-wrap: nowrap;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      border-bottom: 1px solid #444;
      scrollbar-width: none; /* Firefox */
    }
    #epgCategoryTabs::-webkit-scrollbar {
      display: none; /* Chrome/Safari */
    }
    #epgCategoryTabs .nav-item {
      flex: 0 0 auto;
    }
    #epgCategoryTabs .nav-link {
      color: #ccc;
      background: transparent;
      border: 1px solid transparent;
      margin-bottom: -1px;
      white-space: nowrap;
    }
    #epgCategoryTabs .nav-link.active {
      color: #fff;
      background-color: #333;
      border-color: #444 #444 #333;
    }
    #epgCategoryTabs .nav-link:hover {
      border-color: #444;
    }
  </style>

  <script th:inline="javascript">
    /*<![CDATA[*/
    function filterCategory(catId) {
      const channelRows = document.querySelectorAll(
        ".channel-row[data-category-id]"
      );
      const programRows = document.querySelectorAll(
        ".program-row[data-category-id]"
      );

      channelRows.forEach((row) => {
        if (catId === "all" || row.getAttribute("data-category-id") === catId) {
          row.style.display = "flex";
        } else {
          row.style.display = "none";
        }
      });

      programRows.forEach((row) => {
        if (catId === "all" || row.getAttribute("data-category-id") === catId) {
          row.style.display = "flex";
        } else {
          row.style.display = "none";
        }
      });

      // Scroll the selected tab button into view
      const selectedTab =
        catId === "all"
          ? document.getElementById("all-tab")
          : document.getElementById("cat-" + catId);
      if (selectedTab) {
        selectedTab.scrollIntoView({
          behavior: "smooth",
          block: "nearest",
          inline: "center",
        });
      }
    }

    // Ensure keyboard navigation (focus) also scrolls tabs into view
    document.addEventListener("DOMContentLoaded", () => {
      const tabs = document.querySelectorAll(
        '#epgCategoryTabs button[data-bs-toggle="tab"]'
      );
      tabs.forEach((tab) => {
        // When tab is selected (click or keyboard selection)
        tab.addEventListener("shown.bs.tab", (event) => {
          event.target.scrollIntoView({
            behavior: "smooth",
            block: "nearest",
            inline: "center",
          });
        });

        // When focus moves (arrow keys)
        tab.addEventListener("focusin", (event) => {
          event.target.scrollIntoView({
            behavior: "smooth",
            block: "nearest",
            inline: "center",
          });
        });
      });
    });
    /*]]>*/
  </script>
</div>
