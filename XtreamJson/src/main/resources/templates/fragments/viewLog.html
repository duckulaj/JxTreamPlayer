<!-- fragments/viewLog.html -->
<div th:fragment="logView">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Application Log</h2>
    <button class="btn btn-warning" onclick="flushLog()">
      <i class="bi bi-trash"></i> Flush Log
    </button>
  </div>
  <pre id="log-pre" style="max-height: 500px; overflow-y: auto; background: #222; color: #eee; padding: 1em; border-radius: 5px; text-align: left;" th:attr="data-last-modified=${lastModified}">
    <span id="log-content" th:text="${logContent}"></span>
  </pre>

  <script>
    function flushLog() {
      if(!confirm('Are you sure you want to flush and compress the current log?')) return;
      
      fetch('/admin/flushLog')
        .then(response => {
          if (response.ok) {
              return response.text();
          } else {
              throw new Error('Failed to flush log');
          }
        })
        .then(msg => {
            alert(msg);
            // Clear content client-side immediately
            document.getElementById('log-content').textContent = '';
        })
        .catch(err => alert('Error: ' + err.message));
    }

    (function() {
      // Clean up any previous SSE connection when fragment re-renders
      if (window._logViewSse) {
        try { window._logViewSse.close(); } catch (e) {}
        window._logViewSse = null;
      }

      const pre = document.getElementById('log-pre');
      const contentElem = document.getElementById('log-content');
      if (!pre || !contentElem) return;

      // Scroll to bottom helper
      function scrollToBottom() {
        try { pre.scrollTop = pre.scrollHeight; } catch (e) {}
      }

      // Initial scroll to bottom
      setTimeout(scrollToBottom, 50);

      // Create SSE connection
      try {
        const es = new EventSource('/admin/logStream');
        window._logViewSse = es;

        es.addEventListener('log', function(e) {
          // e.data contains full log text
          contentElem.textContent = e.data || '';
          // Update last-modified timestamp to now (server-side SSE doesn't send header)
          pre.dataset.lastModified = String(Date.now());
          scrollToBottom();
        });

        es.addEventListener('notfound', function(e) {
          contentElem.textContent = e.data || 'Log file not found.';
        });

        es.addEventListener('error', function(e) {
          // server-sent error event
          try {
            // if server sent a message body
            contentElem.textContent = e.data || 'Error streaming log.';
          } catch (err) {
            contentElem.textContent = 'Error streaming log.';
          }
        });

        // Fallback for plain message events
        es.onmessage = function(e) {
          contentElem.textContent = e.data || '';
          scrollToBottom();
        };

        es.onerror = function(ev) {
          // EventSource auto-reconnects; show transient message
          // If readyState is CLOSED, try to reopen later
          if (es.readyState === EventSource.CLOSED) {
            // closed by server, indicate to user
            // keep the element content as-is; do not spam
            console.warn('Log SSE connection closed');
          }
        };

      } catch (err) {
        contentElem.textContent = 'Could not open SSE connection: ' + (err && err.message ? err.message : err);
      }

    })();
  </script>
</div>