<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Application Properties</title>
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
  </head>
  <body class="container mt-4">
    <div th:replace="~{fragments/navbar :: navbar}"></div>
    <h2>Application Properties</h2>

    <!-- Main Content Container -->
    <div id="admin-content">
      <div class="mb-3">
        <form
          th:action="@{/admin/properties}"
          th:object="${currentProperties}"
          method="post"
          class="row g-3"
        >
          <input type="hidden" th:field="*{id}" />
          <div class="col-md-4">
            <label for="seriesInfoMaxInflight" class="form-label"
              >Series Info Max Inflight</label
            >
            <input
              type="number"
              class="form-control"
              id="seriesInfoMaxInflight"
              name="seriesInfoMaxInflight"
              th:field="*{seriesInfoMaxInflight}"
              min="1"
              required
            />
          </div>
          <div class="col-md-4">
            <label for="batchSize" class="form-label">Batch Size</label>
            <input
              type="number"
              class="form-control"
              id="batchSize"
              name="batchSize"
              th:field="*{batchSize}"
              min="1"
              required
            />
          </div>
          <div class="col-md-4">
            <label for="maxRetries" class="form-label">Max Retries</label>
            <input
              type="number"
              class="form-control"
              id="maxRetries"
              name="maxRetries"
              th:field="*{maxRetries}"
              min="0"
              required
            />
          </div>
          <div class="col-md-4">
            <label for="includedCountries" class="form-label"
              >Included Countries</label
            >
            <input
              type="text"
              class="form-control"
              id="includedCountries"
              name="includedCountries"
              th:field="*{includedCountries}"
              required
            />
          </div>
          <div class="col-md-4">
            <label for="excludedTitles" class="form-label"
              >Exclude from Playlist</label
            >
            <input
              type="text"
              class="form-control"
              id="excludedTitles"
              name="excludedTitles"
              th:field="*{excludedTitles}"
            />
          </div>

          <div
            class="col-12"
            th:if="${currentProperties.availablePrefixes != null && !currentProperties.availablePrefixes.isEmpty()}"
          >
            <label class="form-label"
              >Available Prefixes (Select to include)</label
            >
            <div class="dropdown">
              <button
                class="btn btn-secondary dropdown-toggle w-100 text-start"
                type="button"
                id="prefixDropdownButton"
                data-bs-toggle="dropdown"
                data-bs-auto-close="outside"
                aria-expanded="false"
              >
                Select Prefixes
              </button>
              <ul
                class="dropdown-menu w-100"
                aria-labelledby="prefixDropdownButton"
                style="max-height: 300px; overflow-y: auto"
              >
                <li th:each="prefix : ${#strings.arraySplit(currentProperties.availablePrefixes, ',')}">
                  <div class="form-check ms-3">
                    <input
                      class="form-check-input prefix-checkbox"
                      type="checkbox"
                      th:id="${'pfx-' + prefix}"
                      th:value="${prefix}"
                      th:checked="${currentProperties.includedCountries != null && #arrays.contains(#strings.arraySplit(currentProperties.includedCountries, ','), prefix)}"
                    />
                    <label
                      class="form-check-label w-100"
                      th:for="${'pfx-' + prefix}"
                      th:text="${prefix}"
                    ></label>
                  </div>
                </li>
              </ul>
            </div>
            <small class="text-muted"
              >Extracted from categories during last refresh.</small
            >
          </div>

          <div class="col-12 mt-3">
            <button type="submit" class="btn btn-primary">Save Settings</button>
          </div>
        </form>
      </div>

      <script>
        document.addEventListener("DOMContentLoaded", function () {
          const checkboxes = document.querySelectorAll(".prefix-checkbox");
          const includedInput = document.getElementById("includedCountries");
          const dropdownButton = document.getElementById("prefixDropdownButton");

          function updateDropdownText() {
            const checkedCount = document.querySelectorAll(".prefix-checkbox:checked").length;
            if (checkedCount === 0) {
                dropdownButton.textContent = "Select Prefixes";
            } else {
                dropdownButton.textContent = checkedCount + " Selected";
            }
          }

          // Initial update
          updateDropdownText();

          checkboxes.forEach((cb) => {
            cb.addEventListener("change", function () {
              let currentValues = includedInput.value
                .split(",")
                .map((s) => s.trim())
                .filter((s) => s.length > 0);

              const val = this.value;

              if (this.checked) {
                if (!currentValues.includes(val)) {
                  currentValues.push(val);
                }
              } else {
                currentValues = currentValues.filter((v) => v !== val);
              }

              includedInput.value = currentValues.join(",");
              updateDropdownText();
            });
          });

          // Also monitor manual changes to input to update checkboxes
          includedInput.addEventListener("input", function () {
            const currentValues = includedInput.value
              .split(",")
              .map((s) => s.trim());

            checkboxes.forEach((cb) => {
              cb.checked = currentValues.includes(cb.value);
            });
            updateDropdownText();
          });
        });
      </script>

      <h4>All Properties Records</h4>
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>ID</th>
            <th>Series Info Max Inflight</th>
            <th>Batch Size</th>
            <th>Max Retries</th>
            <th>Included Countries</th>
            <th>Excluded Titles</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr th:each="prop : ${propertiesList}">
            <td th:text="${prop.id}"></td>
            <td th:text="${prop.seriesInfoMaxInflight}"></td>
            <td th:text="${prop.batchSize}"></td>
            <td th:text="${prop.maxRetries}"></td>
            <td th:text="${prop.includedCountries}"></td>
            <td th:text="${prop.excludedTitles}"></td>
            <td>
              <a
                th:href="@{'/admin/properties/edit/' + ${prop.id}}"
                class="btn btn-sm btn-secondary"
                >Edit</a
              >
              <form
                th:action="@{'/admin/properties/delete/' + ${prop.id}}"
                method="post"
                style="display: inline"
              >
                <button
                  type="submit"
                  class="btn btn-sm btn-danger"
                  onclick="return confirm('Delete this record?');"
                >
                  Delete
                </button>
              </form>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Bootstrap JS Bundle (includes Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
